# 1. ETAPA BASE: Define la imagen de Node LTS (estable)
FROM node:20-slim AS base
# Define el directorio de trabajo dentro del contenedor
WORKDIR /app

# 2. ETAPA DE DEPENDENCIAS: Instala solo las librer铆as
FROM base AS deps
WORKDIR /app
# Copia solo los archivos de configuraci贸n de NPM
COPY package.json package-lock.json ./

# RUN: Instala las dependencias, ignorando los scripts (incluido el generate de Prisma)
RUN npm install --ignore-scripts

#  CORRECCIN: Instala OpenSSL, requerido por Prisma para la conexi贸n a la base de datos.
RUN apt-get update -y && apt-get install -y openssl 

# 3. ETAPA DE CONSTRUCCIN (BUILD): Compila el c贸digo
FROM base AS build
WORKDIR /app
# Copia las dependencias preinstaladas (incluyendo node_modules)
COPY --from=deps /app/node_modules ./node_modules

#  ROMPE EL CACH (SOLUCIN TS2353): Este comando fuerza la invalidaci贸n de la capa COPY . .
RUN touch .cache_buster

# Copia el c贸digo fuente (contiene el PrismaService corregido)
COPY . . 

# Soluci贸n para DATABASE_URL: Se inyecta una URL DUMMY temporal para que 'prisma generate' funcione.
RUN DATABASE_URL="postgresql://user:password@localhost:5432/dummy" npx prisma generate --schema prisma/schema.prisma

# Ahora s铆, compila la aplicaci贸n NestJS
RUN npm run build

# 4. ETAPA DE PRODUCCIN (FINAL): Imagen ligera para ejecuci贸n
# CORRECCIN DE RUNTIME: Cambiamos a la imagen node:20 (no slim) para asegurar que las variables de entorno se lean.
FROM node:20 AS final
WORKDIR /app

# CORRECCIN DE ERROR ENOENT: Copia los archivos de configuraci贸n para poder ejecutar npm start
COPY package.json package-lock.json ./

# Copia solo los archivos de producci贸n: compilados (dist) y dependencias
COPY --from=deps /app/node_modules ./node_modules
COPY --from=build /app/dist ./dist

# Copia el esquema de Prisma (necesario para migrate deploy en runtime)
COPY prisma ./prisma/ 

# Establece el puerto de escucha
EXPOSE 3000

#  CORRECCIN DEFINITIVA DE DATASOURCE EN RUNTIME:
# Ejecuta el comando de migraci贸n y luego el de inicio, forzando la exportaci贸n de la variable para que Prisma la vea.
CMD ["/bin/sh", "-c", "env DATABASE_URL=$DATABASE_URL npx prisma migrate deploy && npm run start:prod"]